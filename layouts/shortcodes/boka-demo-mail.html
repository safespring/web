<script>
function openTerms(id) {
  const terms = {
    "1": "Read more at https://www.safespring.com",
    "3": "" // skriv något vettigt här istället för null
  };
  const preview = window.open(
    "",
    "",
    "height=700,width=800,scrollbars=yes,resizable=yes,toolbar=no,status=no,menubar=no,location=no"
  );
  const html = `
    <head>
      <meta charset="UTF-8">
      <style>
        body { margin:0; padding:20px; color:#333; font-family:Helvetica, Arial, sans-serif; font-size:14px; }
      </style>
    </head>
    <body>${terms[id] ?? ""}</body>`;
  preview.document.write(html);
}
</script>

<form
  id="up-form"
  name="form_9549u4d6d51f2f5fc45b8a4b4c7aba187a704"
  action="https://power.upsales.com/api/external/formSubmit"
  method="POST"
>
  <div class="email">
    <label for="up-email-input">Email *</label><br />
    <input
      id="up-email-input"
      name="Contact.email"
      type="email"
      maxlength="512"
      placeholder=""
      autocomplete="off"
      required
      title="Please enter a valid email"
    />
  </div>

  <!-- REQUIRED FIELDS -->
  <input type="hidden" name="formCid" value="9549" />
  <input type="hidden" name="formId" value="9549u4d6d51f2f5fc45b8a4b4c7aba187a704" />
  <input type="hidden" name="isFrame" value="false" />
  <input type="text" name="validation" value="" style="display:none;" />
  <!-- END OF REQUIRED FIELDS -->

  <div class="submit-button">
    <button type="submit">Boka demo</button>
  </div>
</form>

<script>
(function () {
  const form = document.getElementById("up-form");
  if (!form) return;
  form.addEventListener("submit", function (ev) {
    const button = ev.target.querySelector('button[type="submit"]');
    if (button) button.disabled = true;
  });
})();

function onSubmit(ev) {
  let waitedForEmailValidator = true;
  let isValidEmail = true;

  // Stöd för extern emailvaliderare om den finns
  if (typeof window.__validEmail !== "undefined") {
    isValidEmail = window.__validEmail;
    waitedForEmailValidator = false;
  }

  if (isValidEmail && !waitedForEmailValidator) {
    return validateForm(ev, "https://www.safespring.com");
  }

  ev.preventDefault();
  let ok = false;
  const timer = setInterval(function () {
    const beValid = window._bEmValid;
    if (typeof window.__validEmail !== "undefined" || beValid) {
      ok = window.__validEmail ?? true;
      waitedForEmailValidator = false;
    }
    if ((typeof ok === "boolean" && ok) || !waitedForEmailValidator) {
      clearInterval(timer);
      validateForm(ev, "https://www.safespring.com");
    }
  }, 300);
}

function validateForm(ev, redirectUrl) {
  ev.preventDefault();

  const formIdVal = document.getElementsByName("formId")[0].value;
  const form = document.forms["form_" + formIdVal];

  // Trimma textfält
  const fields = form.querySelectorAll("input, textarea, select");
  for (let i = 0; i < fields.length; i++) {
    if (fields[i].type === "text") fields[i].value = fields[i].value.trim();
  }

  // Intl-tel-input normalisering (om används)
  const phoneFields = form.querySelectorAll('input[name*=phone], input[name*=Phone]');
  phoneFields.forEach(function (el) {
    if (el.iti) el.value = el.iti.getNumber();
  });

  // reCAPTCHA (om laddad)
  if (typeof window.grecaptcha !== "undefined" && window.grecaptcha.getResponse() === "") {
    const recaptchaError = document.getElementById("recaptcha-error");
    if (recaptchaError) recaptchaError.style.display = "block";
    return;
  }

  // Serialisera
  const pairs = [];
  for (let i = 0; i < fields.length; i++) {
    const f = fields[i];
    if (f.type === "checkbox") {
      pairs.push(`${encodeURIComponent(f.name)}=${encodeURIComponent(f.checked ? f.value : "off")}`);
    } else {
      pairs.push(`${encodeURIComponent(f.name)}=${encodeURIComponent(f.value)}`);
    }
  }
  let body = pairs.join("&") + "&isAjax=true";

  const _paq = window._paq || null; // Matomo

  // Skicka
  const xhr = new XMLHttpRequest();
  xhr.open("POST", form.action);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.onload = function () {
    if (xhr.status === 200) {
      if (redirectUrl) {
        if (_paq && _paq.push) _paq.push(["trackLink", "https://post.upsales.com/" + xhr.responseText, "link"]);
        if (typeof _uaq !== "undefined") _uaq("form=" + xhr.responseText);
        setTimeout(function () {
          window.top.location.href = redirectUrl;
        }, 333);
      } else {
        const formEl = document.getElementById("up-form");
        const thanksEl = document.getElementById("up-form-thanks");
        if (formEl && thanksEl) {
          formEl.style.display = "none";
          thanksEl.style.display = "block";
        }
        if (_paq && _paq.push) _paq.push(["trackLink", "https://post.upsales.com/" + xhr.responseText, "link"]);
        if (typeof _uaq !== "undefined") _uaq("form=" + xhr.responseText);
      }
    } else {
      console.log("AJAX ERROR", xhr.status);
      // fallback: normal submit
      form.submit();
    }
  };
  xhr.onerror = function () {
    // fallback: normal submit
    form.submit();
  };
  xhr.send(body);
}

document.getElementById("up-form").addEventListener("submit", onSubmit);
</script>